import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

// Fallback templates used when AI fails
const FALLBACK_TEMPLATES: Record<string, string[]> = {
    "ì—¬í–‰": [
        "âœˆï¸ ì—¬í–‰ì˜ ì„¤ë ˜ì„ ìƒìƒí•˜ê²Œ ì „ë‹¬í•˜ëŠ” í¬ë¦¬ì—ì´í„°ìž…ë‹ˆë‹¤! ìˆ¨ê²¨ì§„ ëª…ì†Œë¶€í„° ë§›ì§‘ê¹Œì§€, ì—¬í–‰ì§€ê°€ ì£¼ëŠ” ê°ë™ì„ êµ¬ë…ìžì™€ í•¨ê»˜ ë‚˜ëˆ•ë‹ˆë‹¤. ë¸Œëžœë“œì˜ ë§¤ë ¥ì„ ì—¬í–‰ì˜ ì¶”ì–µ ì†ì— ìžì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ê² ìŠµë‹ˆë‹¤.",
        "ðŸ—ºï¸ ë– ë‚˜ê³  ì‹¶ì€ ìš•êµ¬ë¥¼ ìžê·¹í•˜ëŠ” ì—¬í–‰ ì½˜í…ì¸ ! ìƒë™ê° ë„˜ì¹˜ëŠ” ì˜ìƒê³¼ ê°ì„±ì ì¸ ì‚¬ì§„ìœ¼ë¡œ ì—¬í–‰ì§€ì˜ ë¶„ìœ„ê¸°ë¥¼ ì™„ë²½í•˜ê²Œ ë‹´ì•„ëƒ…ë‹ˆë‹¤. ì—¬í–‰ ê´€ë ¨ ì œí’ˆì´ë‚˜ ì„œë¹„ìŠ¤ì˜ ìž¥ì ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìžˆëŠ” ìµœê³ ì˜ íŒŒíŠ¸ë„ˆê°€ ë˜ì–´ë“œë¦´ê²Œìš”."
    ],
    "ë·°í‹°": [
        "ðŸ’„ ë·°í‹° íŠ¸ë Œë“œë¥¼ ì„ ë„í•˜ëŠ” ê¼¼ê¼¼í•œ ë¦¬ë·°ì–´! ì œí’ˆì˜ ë°œìƒ‰ë¶€í„° í…ìŠ¤ì²˜ê¹Œì§€ ë””í…Œì¼í•˜ê²Œ ë³´ì—¬ë“œë¦¬ë©°, ì†”ì§í•˜ê³  ì§„ì •ì„± ìžˆëŠ” í›„ê¸°ë¡œ íŒ”ë¡œì›Œë“¤ì˜ ì‹ ë¢°ë¥¼ ì–»ê³  ìžˆìŠµë‹ˆë‹¤. ë¸Œëžœë“œì˜ ì•„ì´ë´í‹°í‹°ë¥¼ ì‚´ë¦° ê°ê°ì ì¸ ì½˜í…ì¸ ë¥¼ ê¸°ëŒ€í•´ì£¼ì„¸ìš”.",
        "âœ¨ ë‚˜ë§Œì˜ ë·°í‹° ê¿€íŒê³¼ í•¨ê»˜ ì œí’ˆì„ ì†Œê°œí•©ë‹ˆë‹¤. ë¹„í¬/ì• í”„í„°ê°€ í™•ì‹¤í•œ ì½˜í…ì¸ ë¡œ ì œí’ˆì˜ íš¨ëŠ¥ì„ ì§ê´€ì ìœ¼ë¡œ ë³´ì—¬ë“œë ¤ìš”. ë·°í‹°ì— ì§„ì‹¬ì¸ ì €ì™€ í•¨ê»˜ ë¸Œëžœë“œì˜ íŒ¬ë¤ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!"
    ],
    "íŒ¨ì…˜": [
        "ðŸ‘— ìŠ¤íƒ€ì¼ë¦¬ì‹œí•œ ë°ì¼ë¦¬ë£©ì˜ ì •ì„! ìµœì‹  íŒ¨ì…˜ íŠ¸ë Œë“œë¥¼ ì €ë§Œì˜ ê°ì„±ìœ¼ë¡œ ìž¬í•´ì„í•˜ì—¬ êµ¬ë…ìžë“¤ì—ê²Œ ì˜ê°ì„ ì¤ë‹ˆë‹¤. ì–´ë–¤ ì˜·ì´ë“  ì°°ë–¡ê°™ì´ ì†Œí™”í•˜ì—¬ ì œí’ˆì˜ í•ê³¼ ë””ìžì¸ì„ ë‹ë³´ì´ê²Œ ë§Œë“¤ì–´ë“œë¦´ê²Œìš”.",
        "ðŸ•¶ï¸ íŒ¨ì…˜ ì„¼ìŠ¤ê°€ ë‹ë³´ì´ëŠ” OOTD ë§›ì§‘. TPOì— ë§žëŠ” ì½”ë”” ì œì•ˆìœ¼ë¡œ ì œí’ˆì˜ í™”ìš©ë„ë¥¼ ë†’ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ê°ê°ì ì¸ ìŠ¤íƒ€ì¼ë§ ì»·ìœ¼ë¡œ ë¸Œëžœë“œì˜ ë£©ë¶ ê°™ì€ í€„ë¦¬í‹°ë¥¼ ë³´ìž¥í•©ë‹ˆë‹¤."
    ],
    "ë§›ì§‘": [
        "ðŸ½ï¸ ë§›ìžˆëŠ” ê±´ ëª» ì°¸ëŠ” ë¯¸ì‹ íƒí—˜ê°€! ì¹¨ìƒ˜ì„ ìžê·¹í•˜ëŠ” ë¨¹ë°©ê³¼ ìƒì„¸í•œ ë§› í‰ê°€ë¡œ íŒ”ë¡œì›Œë“¤ì˜ ë©”ë‰´ ì„ íƒì„ ì±…ìž„ì§ë‹ˆë‹¤. ìŒì‹ì˜ ë§›ê³¼ ë¹„ì£¼ì–¼ì„ ëª¨ë‘ ìž¡ì€ ê³ í€„ë¦¬í‹° ì½˜í…ì¸ ë¡œ ë§¤ìž¥ì˜ ì›¨ì´íŒ…ì„ ëŠ˜ë ¤ë“œë¦´ê²Œìš”!",
        "ðŸ¥˜ í•«í•œ ë§›ì§‘ì€ ë¬´ì¡°ê±´ ê°€ë³´ëŠ” í•«í”Œ ì‚¬ëƒ¥ê¾¼. ë¶„ìœ„ê¸°ë¶€í„° ë§›ê¹Œì§€ ê¼¼ê¼¼í•˜ê²Œ ë¦¬ë·°í•˜ì—¬ ë°©ë¬¸ ìš•êµ¬ë¥¼ ìžê·¹í•©ë‹ˆë‹¤. ì…°í”„ì˜ ì •ì„±ì´ ë‹´ê¸´ ìš”ë¦¬ë¥¼ ë”ìš± ë‹ë³´ì´ê²Œ í•  ë§›ê¹”ë‚˜ëŠ” ë¦¬ë·°ë¥¼ ì•½ì†ë“œë ¤ìš”."
    ],
    "ë¦¬ë¹™/ì¸í…Œë¦¬ì–´": [
        "ðŸ¡ ì§‘ ê¾¸ë¯¸ê¸°ì— ì§„ì‹¬ì¸ í™ˆìŠ¤íƒ€ì¼ë§ ê³ ìˆ˜. ê°ì„± ê°€ë“í•œ ì¸í…Œë¦¬ì–´ ì†Œí’ˆê³¼ ê°€êµ¬ë¡œ ê³µê°„ì˜ ë¶„ìœ„ê¸°ë¥¼ ë°”ê¿‰ë‹ˆë‹¤. ì œí’ˆ í•˜ë‚˜ë¡œ ë‹¬ë¼ì§€ëŠ” ê³µê°„ì˜ ë³€í™”ë¥¼ ë“œë¼ë§ˆí‹±í•˜ê²Œ ë³´ì—¬ë“œë¦´ê²Œìš”. ì˜¤ëŠ˜ì˜ì§‘st ê°ì„± ë³´ìž¥!",
        "ðŸ›‹ï¸ ë¨¸ë¬¼ê³  ì‹¶ì€ ê³µê°„ì„ ë§Œë“œëŠ” ë¼ì´í”„ìŠ¤íƒ€ì¼ í¬ë¦¬ì—ì´í„°. ì‹¤ìš©ì ì´ë©´ì„œë„ ì˜ˆìœ ë¦¬ë¹™ ì•„ì´í…œì„ ì†Œê°œí•˜ë©° êµ¬ë…ìžë“¤ì˜ ì‚´ë¦¼ ìš•êµ¬ë¥¼ ìžê·¹í•©ë‹ˆë‹¤. ë¸Œëžœë“œ ì œí’ˆì´ ì¼ìƒì— ìŠ¤ë©°ë“œëŠ” ìžì—°ìŠ¤ëŸ¬ì›€ì„ ë‹´ì•„ë‚¼ê²Œìš”."
    ],
    "ì›¨ë”©/ê²°í˜¼": [
        "ðŸ’ ì„¸ìƒì—ì„œ ê°€ìž¥ ì•„ë¦„ë‹¤ìš´ ìˆœê°„, ê²°í˜¼ ì¤€ë¹„ì˜ ëª¨ë“  ê²ƒ! ì˜ˆë¹„ ì‹ ë¶€ë“¤ì˜ í­í’ ê³µê°ì„ ì´ëŒì–´ë‚¼ ë¦¬ì–¼í•œ ê²°í˜¼ ì¤€ë¹„ ê³¼ì •ì„ ê³µìœ í•©ë‹ˆë‹¤. ê°€ì „, í˜¼ìˆ˜, ë°ì´íŠ¸ ìŠ¤ëƒ… ë“± ì›¨ë”© ê´€ë ¨ ë¸Œëžœë“œì™€ì˜ íŠ¹ë³„í•œ ë§Œë‚¨ì„ ê¸°ëŒ€í•´ìš”.",
        "ðŸ‘°â€â™€ï¸ D-Dayë¥¼ ì•žë‘” ì˜ˆë¹„ ì‹ ë¶€ì˜ ì„¤ë ˜ ê°€ë“í•œ ë‹¤ì´ì–´ë¦¬. ë“œë ˆìŠ¤ íˆ¬ì–´ë¶€í„° ì‹ í˜¼ì§‘ ìž…ì£¼ê¹Œì§€, ê²°í˜¼ ì¤€ë¹„ì˜ ëª¨ë“  ì—¬ì •ì„ í•¨ê»˜í•˜ë©° ë¸Œëžœë“œì˜ ê°€ì¹˜ë¥¼ ì§„ì •ì„± ìžˆê²Œ ì „ë‹¬í•˜ê² ìŠµë‹ˆë‹¤."
    ],
    "default": [
        "âœ¨ ë¸Œëžœë“œì˜ ê°€ì¹˜ë¥¼ ë†’ì—¬ì¤„ ì¤€ë¹„ëœ í¬ë¦¬ì—ì´í„°ìž…ë‹ˆë‹¤. ì €ë§Œì˜ í†¡í†¡ íŠ€ëŠ” ê°œì„±ê³¼ ì§„ì •ì„± ìžˆëŠ” ìŠ¤í† ë¦¬í…”ë§ìœ¼ë¡œ ì†Œë¹„ìžì—ê²Œ ë‹¤ê°€ê°€ê² ìŠµë‹ˆë‹¤. ë‹¨ìˆœí•œ í™ë³´ë¥¼ ë„˜ì–´, ë¸Œëžœë“œì™€ ì†Œë¹„ìžë¥¼ ìž‡ëŠ” ê°€êµê°€ ë˜ì–´ ì„±ê³µì ì¸ ìº íŽ˜ì¸ì„ ë§Œë“¤ê³  ì‹¶ìŠµë‹ˆë‹¤. í˜‘ì—…ì„ í†µí•´ ì„œë¡œ ìœˆìœˆ(Win-Win)í•˜ëŠ” ì‹œë„ˆì§€ë¥¼ ë‚¼ ìˆ˜ ìžˆê¸°ë¥¼ ê¸°ëŒ€í•©ë‹ˆë‹¤! ðŸ”¥",
        "ðŸŒŸ íŒ”ë¡œì›Œë“¤ê³¼ ëˆëˆí•˜ê²Œ ì†Œí†µí•˜ëŠ” ì¸í”Œë£¨ì–¸ì„œìž…ë‹ˆë‹¤. ì œ ì½˜í…ì¸ ëŠ” ë†’ì€ ë„ë‹¬ìœ¨ê³¼ í™•ì‹¤í•œ ë°˜ì‘ì„ ë³´ìž¥í•©ë‹ˆë‹¤. ë¸Œëžœë“œê°€ ì „í•˜ê³  ì‹¶ì€ ë©”ì‹œì§€ë¥¼ ê°€ìž¥ íš¨ê³¼ì ìœ¼ë¡œ, ê·¸ë¦¬ê³  ë§¤ë ¥ì ìœ¼ë¡œ ì „ë‹¬í•  ìžì‹ ì´ ìžˆìŠµë‹ˆë‹¤. ì§€ê¸ˆ ë°”ë¡œ ì œì•ˆì£¼ì„¸ìš”! ðŸ’Œ"
    ]
};

function getFallbackDescription(category: string, prompt: string): string {
    // Simple logic to pick a template based on category or keywords in title
    const cleanCategory = category.replace(/[^ê°€-íž£\/]/g, ""); // Remove emojis
    const templates = FALLBACK_TEMPLATES[cleanCategory] || FALLBACK_TEMPLATES["default"];

    // Pick random template
    let text = templates[Math.floor(Math.random() * templates.length)];

    // Add user's specific context if available
    if (prompt && prompt.length > 5) {
        text = `"${prompt}"\n\n${text}`;
    }

    return text;
}

export async function POST(req: Request) {
    let prompt = "";
    let category = "";

    try {
        const body = await req.json();
        prompt = body.prompt || "";
        category = body.category || "";

        const apiKey = process.env.GEMINI_API_KEY;

        if (!apiKey) {
            console.warn("API Key missing, using fallback.");
            return NextResponse.json({ result: getFallbackDescription(category, prompt), isFallback: true });
        }

        const genAI = new GoogleGenerativeAI(apiKey);
        // Try the most standard model name
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        const systemPrompt = `
    ë‹¹ì‹ ì€ ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì´ìž ì „ë¬¸ ì¹´í”¼ë¼ì´í„°ìž…ë‹ˆë‹¤.
    ... (ìƒëžµ) ...
    [í¬ë¦¬ì—ì´í„° ìž…ë ¥]: "${prompt}"
    ...
    `;

        // Attempt generation with timeout to prevent long waits
        const result = await Promise.race([
            model.generateContent(systemPrompt),
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 8000))
        ]) as any;

        const response = await result.response;
        const text = response.text();

        return NextResponse.json({ result: text, isFallback: false });

    } catch (error: any) {
        console.error("AI Generation Failed (Switching to Fallback):", error.message);

        // SILENT FAILOVER: Return fallback text instead of error
        const fallbackText = getFallbackDescription(category, prompt);
        return NextResponse.json({
            result: fallbackText,
            isFallback: true,
            errorDetails: error.message // For debugging if needed, but not interrupting user
        });
    }
}
